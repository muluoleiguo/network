补全计划

1TCP是不存在数据边界的，多次调用write函数传递的字符串有可能一次性传递到服务器端，基于TCP的客户端有可能从服务器端接收到多个字符串。



2字符串太长，服务器端拆分，但客户端收到一个就read了

上节例子能运转的情况是巧合而已。

服务器

```C
while((str_len =read(clnt_sock,message,BUF_SIZE))!=0)
    write(clnt_sock,message,str_len);
```

客户端

```c
write(sock,message,strlen(message));
str_len = read(sock,message,BUF_SIZE-1);
```

二者都在循环调用read或者write，但实际上客户端100%接受数据，只不过接受数据时单位有些问题。

注意客户端传输字符串，并且调用write一次性发送，之后调用read，期待接受自己传输的字符串。

但是过一段时间接收，需要等多久？不知道，理想的客户端应该在收到字符串数据时立即读取并输出。



**运算**

尝试自己完成，不要图速度，重在理解与实践，阅读书籍的速度稍慢一些也没问题

客户端连接到服务器端后以1字节整数形式传递待算数字个数

客户端向服务器端传递的每个整数型数据占用4字节

传递整数型数据后接着传递运算符，运算符信息占用1字节

选择字符 + - * 之一传递

服务器端以4字节整数型向客户端传回运算结果

客户端得到运算结果后终止与服务器端的连接



**==TCP原理==**

**TCP套接字中的I/O缓冲**

write函数调用瞬间，数据将移至输出缓冲，read函数调用瞬间，从输入缓冲读取数据

![image-20210118163947785](C:\Users\55018\AppData\Roaming\Typora\typora-user-images\image-20210118163947785.png)

I/O缓冲特性：

1、I/O缓冲在每个TCP套接字中单独存在

2、I/O缓冲在创建套接字时自动生成

3、即使关闭套接字也会继续传递输出缓冲中遗留的数据

4、关闭套接字将丢失输入缓冲中的数据





**不会发生超过输入缓冲大小的数据传输**

TCP会控制数据流，TCP中有滑动窗口协议。计算机网络可算没有白学





**TCP内部工作原理1：与对方的套接字的连接**

1、与对方套接字建立连接

2、与对方套接字进行数据交换

3、断开与对方套接字连接

TCP在实际通信过程中会经过三次对话过程，Three-way handshaking 三次握手

![image-20210118170822667](C:\Users\55018\AppData\Roaming\Typora\typora-user-images\image-20210118170822667.png)

套接字是以全双工（Full-duplex）方式工作的，双向传递数据。

1、请求连接的主机A向主机B传递信息：

[SYN]  SEQ: 1000 ,ACK: -

seq1000含义：现传递的数据包序号是1000，如果接受无误，请通知我 向您传递1001号数据包

这是首次连接时使用的消息，又称为SYN（synchronization）,表示收发数据前传输的同步消息



2、B向A

[SYN+ACK] SEQ:2000, ACK:1001

此时seq2000：现传递的数据包序号为2000，如果接受无误，请通知我向您传递2001号数据包

ack1001：刚才传输的seq为1000的数据包接收无误，现在请传递seq为1001的数据包

对A首次传输的数据包确认（ack 1001） 为B传输数据做准备的（seq 2000）一起发送，此消息称为SYN+ACK.



3A向B：

[ACK] SEQ: 1001 ,   ACK :2001

已正确收到传输的seq为2000的数据包，现在可以传输seq为2001的数据包

AB彼此确定就绪





**TCP内部工作原理2：与对方主机的数据交换**

![image-20210118171829585](C:\Users\55018\AppData\Roaming\Typora\typora-user-images\image-20210118171829585.png)

![image-20210118172051741](C:\Users\55018\AppData\Roaming\Typora\typora-user-images\image-20210118172051741.png)

**原理3：断开与套接字的连接**

![image-20210118172142781](C:\Users\55018\AppData\Roaming\Typora\typora-user-images\image-20210118172142781.png)

FIN表示断开连接，双方个发送1次FIN后断开连接，经历4个阶段，称为4次挥手

