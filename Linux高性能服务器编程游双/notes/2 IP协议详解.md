IP协议为上层协议提供无状态、无连接、不可靠的服务。

1. 无状态（stateless）是指IP通信双方不同步传输数据的状态信息，因此所有IP数据报的发送、传输和接收都是相互独立、没有上下文关系的。
2. 无连接（connectionless）是指IP通信双方都不长久地维持对方的任何信息。这样，上层协议每次发送数据的时候，都必须明确指定对方的IP地址。
3. 不可靠是指IP协议不能保证IP数据报准确地到达接收端，它只是承诺尽最大努力（best effort）

### 2.2.1 IPv4头部结构

![2-1](images\2\2-1.png)

1. 4位版本号（version）指定IP协议的版本。对IPv4来说，其值是4。其他IPv4协议的扩展版本（如SIP协议和PIP协议），则具有不同的版本号（它们的头部结构也和图2-1不同）。
2. 4位头部长度（header length）标识该IP头部有多少个32 bit字（4字节）。因为4位最大能表示15,所以IP头部最长是60字节。
3. 8位服务类型（Type Of Service, TOS）包括一个3位的优先权字段（现在已经被忽略），4位的TOS字段和1位保留字段（必须置0）。4位的TOS字段分别表示：最小延时，最大吞吐量，最高可靠性和最小费用。其中最多有一个能置为1，应用程序应该根据实际需要来设置它。比如像ssh和telnet这样的登录程序需要的是最小延时的服务，而文件传输程序ftp则需要最大吞吐量的服务。
4. 16位总长度（total length）是指整个IP数据报的长度，以字节为单位，因此IP数据报的最大长度为65535 （2^16-1）字节。但由于MTU的限制，长度超过MTU的数据报都将被分片传输，所以实际传输的IP数据报（或分片）的长度都远远没有达到最大值。接下来的3个字段则描述了如何实现分片。
5. 16位标识（identification）唯一地标识主机发送的每一个数据报。其初始值由系统随机生成；每发送一个数据报，其值就加1。该值在数据报分片时被复制到每个分片中，因此同一个数据报的所有分片都具有相同的标识值。
6. 3位标志字段的第一位保留。第二位（Don’t Fragment, DF）表示“禁止分片”。如果设置了这个位，IP模块将不对数据报进行分片。在这种情况下，如果IP数据报长度超过MTU的话，IP模块将丢弃该数据报并返回一个ICMP差错报文。第三位（More Fragment，MF）表示“更多分片”。除了数据报的最后一个分片外，其他分片都要把它置1。
7. 13位分片偏移（fragmentation offset）是分片相对原始IP数据报开始处（仅指数据部分）的偏移。实际的偏移值是该值左移3位（乘8）后得到的。由于这个原因，除了最后一个IP分片外，每个IP分片的数据部分的长度必须是8的整数倍（这样才能保证后面的IP分 片拥有一个合适的偏移值）。
8. 8位生存时间（Time To Live, TTL）是数据报到达目的地之前允许经过的路由器跳数。TTL值被发送端设置（常见的值是64）。数据报在转发过程中每经过一个路由，该值就被路由器减1。当TTL值减为0时，路由器将丢弃数据报，并向源端发送一个ICMP差错报文。TTL值可以防止数据报陷人路由循环。
9. 8位协议（protocol）用来区分上层协议，/etc/protocols文件定义了所有上层协议对应的protocol字段的数值。其中，ICMP是1，TCP是6, UDP是17。
10. 16位头部校验和（header checksum）由发送端填充，接收端对其使用CRC算法以检验IP喊据报头部（注意，仅检验头部）在传输过程中是否损坏。
11. 32位的源端IP地址和目的端IP地址用来标识数据报的发送端和接收端
12. 可选项包括 
    * record route记录路由
    * timestamp时间戳
    * loose source routing 松散路由选择
    * strict source routing 严格路由选择

### 2.2.2使用tcpdump观察IPv4头部结构

## 2.3 IP分片

IP头部中的如下三个字段给IP的分片和重组提供了足够的信息：数据报标识、标志和片偏移。

一个IP数据报的每个分片都具有自己的IP头部，它们具有相同的标识值，但具有不同的片偏移。并且除了最后一个分片外，其他分片都将设置MF标志。此外，每个分片的IP头部的总长度字段将被设置为该分片的长度。

以太网帧的MTU是1500字节（可以通过ifconfig命令或者netstat命令查看），因此它携带的IP数据报的数据部分最多是1480字节（IP头部占用20字节）。考虑用IP数据报封装一个长度为1481字节的ICMP报文（包括8字节的ICMP头部，所以其数据部分长度为1473字节），则该数据报在使用以太网帧传输时必须被分片

![2-2](images\2\2-2.png)

第一个IP分片长度为1500字节，第二个IP分片的长度为21字节。每个IP分片都包含自己的IP头部（20字节）， 且第一个IP分片的IP头部设置了 MF标志，而第二个IP分片的IP头部则没有设置该标志， 因为它已经是最后一个分片了。原始IP数据报中的ICMP头部内容被完整地复制到了第一个IP分片中。第二个IP分片不包含ICMP头部信息，ICMP报文的头部长度取决于报文的类型，



IP层传递给数据链路层的数据可能是一个完整的IP数据报，也可能是一个IP分 片，它们统称为IP分组（packet）

## 2.4 IP路由

路由即决定发送数据报到目标机器的路径

![2-3](images\2\2-3.png)

​		当IP模块接收到来自数据链路层的IP数据报时，它首先对该数据报的头部做CRC校验，确认无误之后就分析其头部的具体信息。

​		如果该IP数据报的头部设置了源站选路选项（松散源路由选择或严格源路由选择），则IP模块调用数据报转发子模块来处理该数据报。如果该IP数据报的头部中目标IP地址是本机的某个IP地址，或者是广播地址，即该数据报是发送给本机的，则IP模块就根据数据报头部中的协议字段来决定将它派发给哪个上层应用（分用）。如果IP模块发现这个数据报不是发送给本机的，则也调用数据报转发子模块来处理该数据报。

​		数据报转发子模块将首先检测系统是否允许转发，如果不允许，IP模块就将数据报丢弃。如果允许，数据报转发子模块将对该数据报执行一些操作，然后将它交给IP数据报输出子模块。

​		IP数据报应该发送至哪个下一跳路由（或者目标机器），以及经过哪个网卡来发送，就是IP路由过程，即图2-3中“计算下一跳路由”子模块。IP模块实现数据报路由的核心数据结构是路由表。这个表按照数据报的目标IP地址分类，同一类型的IP数据报将被发往相同的下一跳路由器（或者目标机器）。

​		IP输出队列中存放的是所有等待发送的IP数据报，其中除了需要转发的IP数据报外，还包括封装了本机上层数据（ICMP报文、TCP报文段、UDP数据报）和IP数据报



### 路由机制

路由表的内容。

![T2-1](images\2\T2-1.png)

该路由表包含两项，每项都包含8个字段

![T2-2](images\2\T2-2.png)

是IP的路由机制，分为3个步骤：

1.  查找路由表中和数据报的目标IP地址完全匹配的主机IP地址。如果找到，就使用该路由项，没找到则转2。
2. 查找路由表中和数据报的目标IP地址具有相同网路ID的网络IP地址。如果有，就使用该路由项；没找到转3。
3. 选择默认路由项，这通常意味着数据报的下一跳路由是网关

### 2.4.3路由表更新

通过route命令或其他工具手工修改路由表，是静态的路由更新方式。对于大型的路由器，它们通常通过BGP （Border Gateway Protocol,边际网关协议）、RIP （RoutingInformation Protocol,路由信息协议）、OSPF等协议来发现路径，并更新自己的路由表。这种更新方式是动态的、自动的。

（计算机网络算是没有白学）



## 2.5 IP转发

不是发送给本机的ip数据报将由数据报转发子模块来处理。路由器都能执行数据报的转发操作，而主机一般只发送和接收数据报，这是因为主机上/proc/sys/net/ipv4/ip_forward内核参数默认被设置为0。

修改它来使能主机的数据报转发功能

`echo 1 > /proc/sys/net/ipv4/ip_forward`

对于允许IP数据报转发的系统（主机或路由器），数据报转发子模块将对期望转发的数
据报执行如下操作：

1. 检查数据报头部的TTL值。如果TTL值已经是0,则丢弃该数据报。
2.  查看数据报头部的严格源路由选择选项。如果该选项被设置，则检测数据报的目标IP地址是否是本机的某个IP地址。如果不是，则发送一个ICMP源站选路失败报文给发送端。
3.  如果有必要，则给源端发送一个ICMP重定向报文，以吿诉它一个更合理的下一跳路由器。
4.  将TTL值减1
5.  处理IP头部选项。
6.  如果有必要，则执行IP分片操作。



## 2.6重定向

### 2.6.1 ICMP重定向报文

![2-4](images\2\2-4.png)

主机重定向，其代码值为1。

ICMP重定向报文的数据部分含义很明确，它给接收方提供了如下两个信息：

1. 引起重定向的IP数据报（即图2-4中的原始IP数据报）的源端IP地址。
2. 应该使用的路由器的IP地址。



### 2.7.1 IPv6固定头部结构

![2-6](images\2\2-6.png)

暂略