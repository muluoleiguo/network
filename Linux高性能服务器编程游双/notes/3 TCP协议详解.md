1. TCP头部信息。TCP头部信息出现在每个TCP报文段中，用于指定通信的源端端口号、目的端端口号，管理TCP连接，控制两个方向的数据流。
2. TCP状态转移过程。TCP连接的任意一端都是一个状态机。在TCP连接从建立到断开的整个过程中，连接两端的状态机将经历不同的状态变迁。
3. TCP数据流。通过分析TCP数据流，我们就可以从网络应用程序外部来了解应用层协议和通信双方交换的应用程序数据。这一部分将讨论两种类型的TCP数据流：交 互数据流和成块数据流。TCP数据流中有一种特殊的数据，称为紧急数据，。
4. TCP数据流的控制。为了保证可靠传输和提高网络通信质量，内核需要对TCP数据流进行控制。这一部分讨论TCP数据流控制的两个方面：**超时重传和拥塞控制**。



## 3.1 TCP服务的特点

TCP协议通信的双方必须先建立连接，然后才能开始数据的读写。双方都必须为该连接分配必要的内核资源，以管理连接的状态和连接上数据的传输。TCP连接是全双工的， 即双方的数据读写可以通过一个连接进行。完成数据交换之后，通信双方都必须断开连接以释放系统资源。

TCP协议的这种连接是一对一的，所以基于广播和多播（目标是多个主机地址）的应用程序不能使用TCP服务。



​		当发送端应用程序连续执行多次写操作时，TCP模块先将这些数据放人TCP发送缓冲区中。当TCP模块真正开始发送数据时，发送缓冲区中这些等待发送的数据可能被封装成一个或多个TCP报文段发出。因此，TCP模块发送出的TCP报文段的个数和应用程序执行的写操作次数之间没有固定的数量关系。

​		当接收端收到一个或多个TCP报文段后，TCP模块将它们携带的应用程序数据按照TCP报文段的序号依次放人TCP接收缓冲区中，并通知应用程序读取数据。接收端应用程序可以一次性将TCP接收缓冲区中的数据全部读出，也可以分多次读取，这取决于用户指定的应用程序读缓冲区的大小。因此，应用程序执行的读操作次数和TCP模块接收到的TCP报文段个数之间也没有固定的数量关系。

综上所述，发送端执行的写操作次数和接收端执行的读操作次数之间没有任何数量关系，这就是字节流的概念：应用程序对数据的发送和接收是**没有边界**限制的。

![image-20210122120113756](C:\Users\55018\AppData\Roaming\Typora\typora-user-images\image-20210122120113756.png)

![image-20210122120118510](C:\Users\55018\AppData\Roaming\Typora\typora-user-images\image-20210122120118510.png)

## 3.2 TCP头部结构

TCP头部信息用于指定通信的源端端口，目的端端口，管理TCP连接等

### 3.2.1 TCP固定头部结构

诸多字段为管理TCP连接和控制数据流提供了足够的信息。

![image-20210122120448238](C:\Users\55018\AppData\Roaming\Typora\typora-user-images\image-20210122120448238.png)

1. 16位端口号（port number）:告知主机该报文段是来自哪里（源端口）以及传给哪个上层协议或应用程序（目的端口）的。进行TCP通信时，客户端通常使用系统自动选择的临时端口号，而服务器则使用知名服务端口号。
2. 32位序号（sequence number）: —次TCP通信（从TCP连接建立到断开）过程中某一个传输方向上的字节流的每个字节的编号。假设主机A和主机B进行TCP通信，A发送给B的第一个TCP报文段中，序号值被系统初始化为某个随机值ISN （Initial Sequence Number,初始序号值）。那么在该传输方向上（从A到B）,后续的TCP报文段中序号值将被系统设置成ISN加上该报文段所携带数据的第一个字节在整个字节流中的偏移。例：某个TCP报文段传送的数据是字节流中的第1025〜2048字节，那么该报文段的序号值就是ISN+1025。另外一个传输方向(从B到A)的TCP报文段的序号值也具有相同的含义。
3. 32位确认号(acknowledgement number):用作对另一方发送来的TCP报文段的响应。其值是收到的TCP报文段的序号值加1。假设主机A和主机B进行TCP通信，那么A发送出的TCP报文段不仅携带自己的序号，而且包含对B发送来的TCP报文段的确认号。反之， B发送出的TCP报文段也同时携带自己的序号和对A发送来的报文段的确认号。
4. 4位头部长度(header length):标识该TCP头部有多少个32bit字(4字节)。因为4位最大能表示15,所以TCP头部最长是60字节。
5. 6位标志位包含如下几项：
   * URG标志，表示紧急指针(urgent pointer)是否有效。
   * ACK标志，表示确认号是否有效。我们称携带ACK标志的TCP报文段为**确认报文段**。
   * PSH标志，提示接收端应用程序应该立即从TCP接收缓冲区中读走数据，为接收后续数据腾出空间(如果应用程序不将接收到的数据读走，它们就会一直停留在TCP接收缓冲区中)。
   * RST标志，表示要求对方重新建立连接。我们称携带RST标志的TCP报文段为**复位报文段**。
   * SYN标志，表示请求建立一个连接。我们称携带SYN标志的TCP报文段为同步报文段。
   * FIN标志，表示通知对方本端要关闭连接了。我们称携带FIN标志的TCP报文段为**结束报文段**。

6. 16位窗口大小(window size):是TCP流量控制的一个手段。这里说的窗口，指的是接收通告窗口(Receiver Window，RWND)。它告诉对方本端的TCP接收缓冲区还能容纳多少字节的数据，这样对方就可以控制发送数据的速度。
7. 16位校验和(TCP checksum):由发送端填充，接收端对TCP报文段执行CRC算法以检验TCP报文段在传输过程中是否损坏。注意，这个校验不仅包括TCP头部，也包括数据部分。这也是TCP可靠传输的一个重要保障。
8. 16位紧急指针(urgent pointer):是一个正的偏移量。它和序号字段的值相加表示最后一个紧急数据的下一字节的序号。因此，确切地说，这个字段是紧急指针相对当前序号的偏移，不妨称之为紧急偏移。TCP的紧急指针是发送端向接收端发送紧急数据的方法。



### 3.2.2 TCP头部选项

TCP头部的最后一个选项字段(options)是可变长的可选信息。这部分最多包含40字节，因为TCP头部最长是60字节(其中还包含前面讨论的20字节的固定部分)。

![image-20210122120909606](C:\Users\55018\AppData\Roaming\Typora\typora-user-images\image-20210122120909606.png)

选项的第一个字段kind说明选项的类型。有的TCP选项没有后面两个字段，仅包含1字节的kind字段。第二个字段length （如果有的话）指定该选项的总长度，该长度包括kind字段和length字段占据的2字节。第三个字段info （如果有的话）是选项的具体信息。常见的TCP选项有7种，

![image-20210122120930963](C:\Users\55018\AppData\Roaming\Typora\typora-user-images\image-20210122120930963.png)

* kind=0是选项表结束选项。
* kind=1是空操作（nop）选项，没有特殊含义，一般用于将TCP选项的总长度填充为4字节的整数倍。
* kind=2是最大报文段长度选项。TCP连接初始化时，通信双方使用该选项来协商最大报文段长度（Max Segment Size, MSS）。TCP模块通常将MSS设置为（MTU-40）字节（减掉的这40字节包括20字节的TCP头部和20字节的IP头部）。这样携带TCP报文段的IP数据报的长度就不会超过MTU （假设TCP头部和IP头部都不包含选项字段，并且这也是一般情况），从而避免本机发生IP分片。对以太网而言，MSS值是1460 （1500-40）字节。
* kind=3是窗口扩大因子选项。TCP连接初始化时，通信双方使用该选项来协商接收通告窗口的扩大因子。在TCP的头部中，接收通告窗口大小是用16位表示的，故最大为65535字节，但实际上TCP模块允许的接收通告窗口大小远不止这个数（为了提高TCP通信的吞吐量）。窗口扩大因子解决了这个问题。假设TCP头部中的接收通告窗口大小是M 窗口扩大因子（移位数）是M，那么TCP报文段的实际接收通告窗口大小是N乘2^M、或者说N左移M位。注意，M的取值范围是0〜14。
* kind=4是选择性确认（Selective Acknowledgment, SACK）选项。TCP通信时，如果某个TCP报文段丢失，则TCP模块会重传最后被确认的TCP报文段后续的所有报文段，这样原先已经正确传输的TCP报文段也可能重复发送，从而降低了 TCP性能。SACK技术正是为改善这种情况而产生的，它使TCP模块只重新发送丢失的TCP报文段，不用发送所有未被确认的TCP报文段。
* kind=5是SACK实际工作的选项。该选项的参数告诉发送方本端已经收到并缓存的不连续的数据块，从而让发送端可以据此检查并重发丢失的数据块。
* kind=8是时间戳选项。该选项提供了较为准确的计算通信双方之间的回路时间（RoundTrip Time, RTT）的方法，从而为TCP流量控制提供重要信息。



续P53